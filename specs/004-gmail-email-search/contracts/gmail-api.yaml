openapi: 3.1.0
info:
  title: Gmail Email Search & CV Extraction API
  version: 1.0.0
  description: |
    REST API for searching Gmail emails by date range, filtering by sender/subject/body,
    and downloading CV attachments (PDF/DOC/DOCX files).

    ## Authentication
    All endpoints require OAuth 2.0 authentication via Google. Users must authorize the
    application to access their Gmail account before using any endpoints.

    ## Rate Limiting
    - Gmail API: 250 quota units per user per second
    - Search requests: 10 per minute per user
    - Attachment downloads: 100 per minute (global)

  contact:
    name: ProActive People API Support
    email: api@proactivepeople.com

servers:
  - url: http://localhost:8080/api/v1
    description: Local development
  - url: https://api-staging.proactivepeople.com/v1
    description: Staging environment
  - url: https://api.proactivepeople.com/v1
    description: Production environment

tags:
  - name: Authentication
    description: OAuth 2.0 authentication endpoints
  - name: Email Search
    description: Search and filter Gmail emails
  - name: Attachments
    description: Download and manage CV attachments
  - name: Sessions
    description: Session management

security:
  - oauth2: []

paths:
  # Authentication Endpoints
  /auth/google:
    get:
      tags:
        - Authentication
      summary: Initiate OAuth 2.0 flow
      description: Redirects user to Google OAuth consent screen
      operationId: initiateOAuth
      security: []  # No auth required for OAuth initiation
      responses:
        '302':
          description: Redirect to Google OAuth consent screen
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/google/callback:
    get:
      tags:
        - Authentication
      summary: OAuth 2.0 callback
      description: Handles OAuth callback from Google and creates user session
      operationId: oauthCallback
      security: []  # No auth required for callback
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from Google
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: CSRF protection state parameter
      responses:
        '302':
          description: Redirect to application with session cookie
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: Destroys user session and revokes OAuth tokens
      operationId: logout
      responses:
        '204':
          description: Successfully logged out
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/status:
    get:
      tags:
        - Authentication
      summary: Check authentication status
      description: Returns current user info and token status
      operationId: authStatus
      responses:
        '200':
          description: Authentication status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # Email Search Endpoints
  /emails/search:
    post:
      tags:
        - Email Search
      summary: Search emails
      description: |
        Search user's Gmail inbox by date range with optional filters.
        Returns paginated results (50 emails per page).
      operationId: searchEmails
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /emails/{messageId}:
    get:
      tags:
        - Email Search
      summary: Get email details
      description: Retrieve full details of a specific email message
      operationId: getEmail
      parameters:
        - $ref: '#/components/parameters/MessageId'
      responses:
        '200':
          description: Email details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmailMessage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # Attachment Endpoints
  /emails/{messageId}/attachments/{attachmentId}:
    get:
      tags:
        - Attachments
      summary: Download attachment
      description: |
        Download a CV attachment. File is stored temporarily for 24 hours.
        Warns if file size exceeds 25MB.
      operationId: downloadAttachment
      parameters:
        - $ref: '#/components/parameters/MessageId'
        - $ref: '#/components/parameters/AttachmentId'
      responses:
        '200':
          description: File download
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            application/msword:
              schema:
                type: string
                format: binary
            application/vnd.openxmlformats-officedocument.wordprocessingml.document:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              description: 'attachment; filename="cv.pdf"'
            X-File-Size-Warning:
              schema:
                type: string
              description: Present if file exceeds 25MB
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /attachments/bulk-download:
    post:
      tags:
        - Attachments
      summary: Bulk download attachments
      description: |
        Download multiple CV attachments as a ZIP archive.
        Limited to 100 files per request.
      operationId: bulkDownloadAttachments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkDownloadRequest'
      responses:
        '200':
          description: ZIP archive of attachments
          content:
            application/zip:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              description: 'attachment; filename="cvs.zip"'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /attachments/history:
    get:
      tags:
        - Attachments
      summary: Get download history
      description: List user's downloaded files (including deleted ones for audit)
      operationId: getDownloadHistory
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Download history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DownloadHistoryResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # Session Endpoints
  /sessions/current:
    get:
      tags:
        - Sessions
      summary: Get current session
      description: Returns current session information
      operationId: getCurrentSession
      responses:
        '200':
          description: Session information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    oauth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://accounts.google.com/o/oauth2/v2/auth
          tokenUrl: https://oauth2.googleapis.com/token
          scopes:
            'https://www.googleapis.com/auth/gmail.readonly': Read email messages
            'https://www.googleapis.com/auth/userinfo.email': User email address
            'https://www.googleapis.com/auth/userinfo.profile': User profile info

  parameters:
    MessageId:
      name: messageId
      in: path
      required: true
      schema:
        type: string
      description: Gmail message ID

    AttachmentId:
      name: attachmentId
      in: path
      required: true
      schema:
        type: string
      description: Gmail attachment ID

  schemas:
    # Authentication Schemas
    AuthStatus:
      type: object
      required:
        - authenticated
      properties:
        authenticated:
          type: boolean
        user:
          $ref: '#/components/schemas/User'
        tokenExpiry:
          type: string
          format: date-time
          description: OAuth token expiration time

    User:
      type: object
      required:
        - id
        - email
        - gmailAddress
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
          nullable: true
        gmailAddress:
          type: string
          format: email
          pattern: '^.*@gmail\.com$'

    # Search Schemas
    SearchRequest:
      type: object
      required:
        - startDate
        - endDate
      properties:
        startDate:
          type: string
          format: date
          description: Start date (inclusive)
          example: '2025-01-01'
        endDate:
          type: string
          format: date
          description: End date (inclusive)
          example: '2025-01-31'
        senderFilter:
          type: string
          format: email
          description: Filter by sender email address
          example: 'candidate@example.com'
        subjectFilter:
          type: string
          maxLength: 200
          description: Filter by subject keywords
          example: 'Application'
        bodyFilter:
          type: string
          maxLength: 500
          description: Filter by email body keywords
          example: 'Java Developer'
        page:
          type: integer
          default: 1
          minimum: 1
          description: Page number (50 emails per page)

    SearchResponse:
      type: object
      required:
        - emails
        - pagination
      properties:
        emails:
          type: array
          items:
            $ref: '#/components/schemas/EmailMessage'
        pagination:
          $ref: '#/components/schemas/Pagination'
        executionTime:
          type: integer
          description: Search execution time in milliseconds

    EmailMessage:
      type: object
      required:
        - id
        - threadId
        - sender
        - subject
        - date
        - hasAttachments
      properties:
        id:
          type: string
          description: Gmail message ID
        threadId:
          type: string
          description: Gmail thread ID
        sender:
          $ref: '#/components/schemas/EmailAddress'
        recipients:
          type: array
          items:
            $ref: '#/components/schemas/EmailAddress'
        subject:
          type: string
          maxLength: 998
        snippet:
          type: string
          maxLength: 200
          description: First 200 characters of body
        body:
          type: object
          properties:
            plain:
              type: string
              nullable: true
            html:
              type: string
              nullable: true
        date:
          type: string
          format: date-time
        hasAttachments:
          type: boolean
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/Attachment'
        labels:
          type: array
          items:
            type: string

    EmailAddress:
      type: object
      required:
        - email
      properties:
        name:
          type: string
          nullable: true
        email:
          type: string
          format: email

    Attachment:
      type: object
      required:
        - id
        - messageId
        - filename
        - mimeType
        - size
      properties:
        id:
          type: string
          description: Gmail attachment ID
        messageId:
          type: string
          description: Parent message ID
        filename:
          type: string
          maxLength: 255
        mimeType:
          type: string
          enum:
            - application/pdf
            - application/msword
            - application/vnd.openxmlformats-officedocument.wordprocessingml.document
        size:
          type: integer
          format: int64
          description: File size in bytes
        downloadUrl:
          type: string
          format: uri
          nullable: true
          description: Temporary download URL (available after download)
        sizeWarning:
          type: boolean
          description: True if file exceeds 25MB

    Pagination:
      type: object
      required:
        - currentPage
        - totalPages
        - totalCount
        - pageSize
      properties:
        currentPage:
          type: integer
          minimum: 1
        totalPages:
          type: integer
          minimum: 0
        totalCount:
          type: integer
          minimum: 0
          description: Total number of emails matching query
        pageSize:
          type: integer
          default: 50
          description: Emails per page
        hasNext:
          type: boolean
        hasPrevious:
          type: boolean

    # Attachment Schemas
    BulkDownloadRequest:
      type: object
      required:
        - attachments
      properties:
        attachments:
          type: array
          maxItems: 100
          items:
            type: object
            required:
              - messageId
              - attachmentId
            properties:
              messageId:
                type: string
              attachmentId:
                type: string

    DownloadHistoryResponse:
      type: object
      required:
        - downloads
        - pagination
      properties:
        downloads:
          type: array
          items:
            $ref: '#/components/schemas/DownloadRecord'
        pagination:
          $ref: '#/components/schemas/Pagination'

    DownloadRecord:
      type: object
      required:
        - id
        - filename
        - mimeType
        - fileSize
        - downloadedAt
        - scheduledCleanupAt
      properties:
        id:
          type: string
          format: uuid
        messageId:
          type: string
        attachmentId:
          type: string
        filename:
          type: string
        mimeType:
          type: string
        fileSize:
          type: integer
          format: int64
        downloadedAt:
          type: string
          format: date-time
        scheduledCleanupAt:
          type: string
          format: date-time
        deletedAt:
          type: string
          format: date-time
          nullable: true
        available:
          type: boolean
          description: True if file still exists and can be re-downloaded

    # Session Schemas
    Session:
      type: object
      required:
        - id
        - userId
        - createdAt
      properties:
        id:
          type: string
        userId:
          type: string
          format: uuid
        gmailAddress:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
        lastActivity:
          type: string
          format: date-time

    # Error Schemas
    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Additional error context
        requestId:
          type: string
          format: uuid
          description: Request ID for debugging

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: BAD_REQUEST
            message: Invalid date range - start date must be before end date
            requestId: 550e8400-e29b-41d4-a716-446655440000

    Unauthorized:
      description: Unauthorized - authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: UNAUTHORIZED
            message: Authentication required. Please log in with your Gmail account.
            requestId: 550e8400-e29b-41d4-a716-446655440000

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: NOT_FOUND
            message: Email message not found
            requestId: 550e8400-e29b-41d4-a716-446655440000

    PayloadTooLarge:
      description: Payload too large
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: PAYLOAD_TOO_LARGE
            message: File size exceeds maximum allowed (25MB)
            requestId: 550e8400-e29b-41d4-a716-446655440000

    UnsupportedMediaType:
      description: Unsupported file type
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: UNSUPPORTED_MEDIA_TYPE
            message: File type not supported. Only PDF, DOC, and DOCX files are allowed.
            requestId: 550e8400-e29b-41d4-a716-446655440000

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: TOO_MANY_REQUESTS
            message: Rate limit exceeded. Please try again in 30 seconds.
            details:
              retryAfter: 30
            requestId: 550e8400-e29b-41d4-a716-446655440000
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit resets

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: INTERNAL_SERVER_ERROR
            message: An unexpected error occurred. Please try again later.
            requestId: 550e8400-e29b-41d4-a716-446655440000
